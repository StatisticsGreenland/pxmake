---
title: "Pxmake template"
author: "LarsP"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(pxweb)
library(jsonlite)

```

## Pxmake, do template



Executing this RMarkdown creates a first version of the Excel spreadsheet, that holds all metadata needed to convert a tidy dataset to a px-file, with pxmake:  
  
pxmake(source-rds-data, meta-data-xlsx. px-file-name)  
  
Before being ready to use the pxmake package, you have allready created a tidy-dataset.

As example for this template creator, a dataset from the Greenlandic Statbank is extracted 


```{r getdata, echo=FALSE, warning=FALSE, message=FALSE}

px_data <- 
  pxweb_get(url = "https://bank.stat.gl/api/v1/en/Greenland/BE/BE80/BE8020/BEXCALCS.px",
      query =   list("year of birth" = c("*"),
       "place of birth"   = c("N","S"),
       "population"=c("P"),
       "sex"=c("M","F"),
       "time"=c("*"))
) %>% 
  as.data.frame(
    column.name.type = "code",                           variable.value.type = "code"
                            ) %>% 
  select(cohort=`year of birth`,
         pob=`place of birth`,
         measure=population,
         sex,
         time,
         count=`Population Estimates`) %>% 
  mutate(cohort=strtoi(cohort),
         time=strtoi(time),
         age=time-cohort-1) %>% 
  filter(age>=0 & age <= 100) %>% 
  select(pob,measure,age,time,cohort,sex,count) %>% 
  arrange(pob,measure,age,time,cohort,sex)


head(px_data)

```


Pretend that it is this dataset you want to convert to a px-file, to be presented with Pxweb/Pxwin/Pxedit


Metadata in a pxfile can be in one or multiple languages and at Statistics Greenland the language information is in

LANGUAGE="en";
LANGUAGES="en","da","kl";

We have chosen English as main language in the px-files

```{r languages, echo=FALSE, warning=FALSE, message=FALSE}

# setup for Statistics Greenland:

mainlanguage <- "English"
mainlanguage_code <- tolower("en")

multilanguage1 <- "Dansk"
multilanguage1_code <- tolower("da")

multilanguage2 <- "Kalaallisut"
multilanguage2_code <- tolower("kl")

LANGUAGE <- "en"
LANGUAGES <- c("en","da","kl")

```



In Pxweb/Pxwin pxfiles are grouped by Subject. Each pxfile therefore holds needed information as SUBJECT-CODE/SUBJECT-AREA, where SUBJECT-AREA is the presented language specific text. To make sure, to get the right translation/spelling, you only specify the repository and the SUBEJCT-CODE


```{r subject_code, echo=FALSE, warning=FALSE, message=FALSE}


subjectget <- function(lang) {
    subarea <- fromJSON(glue::glue(repository))
    return(subarea)
  }

repository <- "https://bank.stat.gl/api/v1/{lang}/Greenland"
lang <- c("en","da","kl")


subject_area <- lang %>% map_df(~ subjectget(.x),.id="langcode") %>%
    filter(id=="BE")

print(subject_area)

```




General keywords for Stat.

CHARSET="ANSI/utf8";
PXVERSION

```{r charset, echo=FALSE, warning=FALSE, message=FALSE}

# setup for Statistics Greenland:

CHARSET <- "ANSI"



```



```{r Do_General, echo=FALSE, warning=FALSE, message=FALSE}

sheet_General <- tibble::tribble(
                                 ~keyword, ~value,
                                "CHARSET",      CHARSET,
                           "AXIS-VERSION",      "2000",
                               "LANGUAGE",      LANGUAGE,
                              "LANGUAGES",      LANGUAGES,
                          "CREATION-DATE",      FALSE,
                            "NEXT-UPDATE",      FALSE,
                              "PX-SERVER",      FALSE,
                         "DIRECTORY-PATH",      FALSE
)
                         
#sheet_General_lang <- tibble::tribble(
#                                 ~keyword, ~en_value, ~da_value, ~kl_value)
                                


```

The tidy dataset that has to be described with metadata has x variables. Some of these can be reused from existing tables

the variable pob is 'place of birth' and can be found in many tables, here from BEXSTA

the variable sex is found as gender, also from BEXSTC

the variable age is from BEXSTD





```{r Do_Codelists, echo=FALSE, warning=FALSE, message=FALSE}


varget <- function(matrix, lang){
  
  repository <- statbank |> glue::glue()
  tmp        <- glue::glue("{repository}?query={matrix}") |> jsonlite::fromJSON()
  varipx     <- glue::glue("{repository}{tmp$path}/{tmp$id}") |> jsonlite::fromJSON()
  
  varipx |> pluck("variables") |> as_tibble() |> unnest(everything())

}


statbank <- "https://bank.stat.gl/api/v1/{lang}/Greenland"
lang <- c("en", "da", "kl") |> set_names()

pob <- lang |> 
  map_dfr(~ varget("BEXSTA", .x), .id = "langcode") |>
  select(langcode, code, text, values, valueTexts) |> 
  filter(code %in% c("place of birth"))

sex <- lang |> 
  map_dfr(~ varget("BEXSTC", .x), .id = "langcode") |>
  select(langcode, code, text, values, valueTexts) |> 
  filter(code %in% c("gender"))

age <- lang |> 
  map_dfr(~ varget("BEXSTD", .x), .id = "langcode") |>
  select(langcode, code, text, values, valueTexts) |> 
  filter(code %in% c("age"))


area <- lang |> 
  map_dfr(~ varget("BEXSTC", .x), .id = "langcode") |>
  select(langcode, code, text, values, valueTexts) |> 
  filter(code %in% c("district"))



statbank <- "https://statbank.hagstova.fo//api/v1/{lang}/H2"
lang <- c("en", "fo") |> set_names()

event <- lang |> 
  map_dfr(~ varget("Lexis.px", .x), .id = "langcode") |>
  select(langcode, code, text, values, valueTexts) |> 
  filter(code %in% c("event"))


#add residence to codelists

head(pob)

head(sex)

head(age)


```




