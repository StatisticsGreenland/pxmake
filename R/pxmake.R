#' Get metadata from 'General' sheet in Excel Workbook
#'
#' @param metadata_path Path to metadata file
get_general_metadata <- function(metadata_path) {
  metadata_path %>%
    readxl::read_xlsx(sheet = "General") %>%
    tidyr::separate(keyword,
                    c("keyword", "language"),
                    sep = "_(?=[en|da|kl|fo])",
                    fill = "right"
                    )
}

#' Get metadata from 'Variables' sheet in Excel Workbook
#'
#' @param metadata_path Path to metadata file
get_variables_metadata <- function(metadata_path) {
  metadata_path %>%
    readxl::read_xlsx(sheet = "Variables") %>%
    tidyr::pivot_longer(cols = -c(position, variable, type),
                        names_to = c("language", "long_name"),
                        names_pattern = "^([[:alpha:]]*)_(.*)$"
                        ) %>%
    tidyr::pivot_wider(names_from = long_name, values_from = value)
}

#' Get metadata from 'Codelists' sheet in Excel Workbook
#'
#' @param metadata_path Path to metadata file
get_codelist_metadata <- function(metadata_path) {
  metadata_path %>%
    readxl::read_xlsx(sheet = "Codelists") %>%
    tidyr::pivot_longer(cols = ends_with("_code_label"),
                        names_to = c("language"),
                        names_pattern = "^([[:alpha:]]*)_.*$"
                        )
}

#' Sort metdata keywords in recommended order
#'
#' @param metadata Data frame with metadata.
#'
#' @returns data frame
sort_metadata <- function(metadata) {
  metadata %>%
    dplyr::mutate(tmp_keyword = stringr::str_extract(keyword, "[[:upper:]-]+")) %>%
    dplyr::left_join(get_px_keywords()[c('keyword', 'order')],
                     by = c('tmp_keyword' = 'keyword')
                     ) %>%
    dplyr::arrange(order, keyword) %>%
    dplyr::select(-tmp_keyword, -order)
}

#' Create metadata for header in PX file
#'
#' The metadata is generated from an Excel sheet and from the source data.
#'
#' @param metadata_path Path to metadata
#' @param source_data_path Path to source data
get_metadata <- function(metadata_path, source_data_path) {
  # Generate metadata from first sheet in Excel workbook.
  # Datasets starting with 'metadata_' are part of the final metadataset.
  variables <- get_variables_metadata(metadata_path)

  time_values <-
    source_data_path %>%
    readRDS() %>%
    dplyr::ungroup() %>%
    dplyr::distinct(time) %>%
    dplyr::pull(1)

  metadata_time <-
    variables %>%
    dplyr::filter(tolower(type) == "time") %>%
    dplyr::mutate(keyword = add_language_to_keyword("VALUES", language) %>%
                              add_sub_key_to_keyword(long_name),
                  value = str_quote(time_values) %>%
                            stringr::str_c(collapse = ',')
                  ) %>%
    dplyr::arrange(keyword) %>%
    dplyr::select(keyword, value)

  metadata_stub_and_head <-
    variables %>%
    tidyr::drop_na(position) %>%
    dplyr::mutate(keyword =
                    dplyr::case_when(stringr::str_starts(position, 's') ~ 'STUB',
                                     stringr::str_starts(position, 'h') ~ 'HEADING',
                                     TRUE ~ NA_character_
                                     ) %>%
                                     add_language_to_keyword(language)
                  ) %>%
    dplyr::arrange(position, keyword) %>%
    dplyr::group_by(keyword) %>%
    dplyr::mutate(value = str_quote(long_name) %>% stringr::str_c(collapse = ',')) %>%
    dplyr::ungroup() %>%
    dplyr::distinct(keyword, value)

  metadata_variables <-
    variables %>%
    tidyr::pivot_longer(cols = c("note", "domain", "elimination")) %>%
    tidyr::drop_na(value) %>%
    dplyr::arrange(name, position) %>%
    dplyr::mutate(keyword = toupper(name) %>%
                              add_language_to_keyword(language) %>%
                              add_sub_key_to_keyword(long_name),
                  value = str_quote(value)
                  ) %>%
    dplyr::select(keyword, value)

  metadata_codes_values_precision <-
    get_codelist_metadata(metadata_path) %>%
    dplyr::left_join(variables %>% dplyr::select(variable, language, long_name),
                     by = c("variable", "language")
                     ) %>%
    dplyr::mutate(VarName2 = paste0(long_name, str_quote(","), value)) %>%
    tidyr::pivot_longer(cols = c("code",  "value", "precision"),
                        names_to = "type"
                        ) %>%
    dplyr::mutate(keyword = dplyr::case_when(type == 'code'      ~ 'CODES',
                                             type == 'value'     ~ 'VALUES',
                                             type == 'precision' ~ 'PRECISION',
                                             TRUE ~ NA_character_
                                             ) %>%
                                             add_language_to_keyword(language) %>%
                                             add_sub_key_to_keyword(long_name)
                  ) %>%
    dplyr::arrange(keyword, sortorder) %>%
    dplyr::group_by(keyword) %>%
    dplyr::mutate(value = ifelse(type %in% c('code','value'),
                                 str_quote(value) %>% stringr::str_c(collapse = ','),
                                 value)
                  ) %>%
    dplyr::ungroup() %>%
    tidyr::drop_na(value) %>%
    dplyr::mutate(keyword2 = dplyr::case_when(type == 'precision' ~ 'PRECISION',
                                              TRUE ~ NA_character_
                                              ) %>%
                                              add_language_to_keyword(language) %>%
                                              add_sub_key_to_keyword(VarName2)
                  ) %>%
    dplyr::distinct(type, keyword,keyword2, value) %>%
    dplyr::mutate(keyword = ifelse(type == 'precision', keyword2, keyword)) %>%
    dplyr::distinct(keyword, value) %>%
    dplyr::relocate(keyword)

  metadata_general <-
    get_general_metadata(metadata_path) %>%
    dplyr::mutate(keyword = add_language_to_keyword(keyword, language),
                  value = tidyr::replace_na(value, "")
                  ) %>%
    dplyr::arrange(!is.na(language)) %>%
    dplyr::select(keyword, value)

  return(dplyr::bind_rows(metadata_general,
                          metadata_stub_and_head,
                          metadata_codes_values_precision,
                          metadata_time,
                          metadata_variables
                          ) %>% sort_metadata()
         )
}

#' Create data cube from source and meta data
#'
#' The data cube has one column for each value of HEADING and is sorted by
#' value. There is one row for each combination of values of STUB variables. The
#' ordering of STUB variables are set in the metadata.
#'
#' @param metadata_path Path to metadata.
#' @param source_data_path Path to source data
get_data_cube <- function(metadata_path, source_data_path) {
  variables <-
    get_variables_metadata(metadata_path) %>%
    dplyr::arrange(position)

  stub_vars <-
    variables %>%
    dplyr::filter(stringr::str_starts(position, 's'), language == "en") %>%
    dplyr::pull(variable)

  heading_vars <-
    variables %>%
    dplyr::filter(stringr::str_starts(position, 'h'), language == "en") %>%
    dplyr::pull(variable)

  codelist <-
    get_codelist_metadata(metadata_path) %>%
    dplyr::left_join(variables %>% dplyr::select(variable, language, long_name),
                     by = c("variable", "language")
                     ) %>%
    dplyr::filter(language == "en") %>%
    dplyr::select(variable, sortorder, code)

  source_data <-
    source_data_path %>%
    readRDS() %>%
    dplyr::ungroup() %>%
    # Complete data so all values of all variables appear in all combinations
    tidyr::complete(!!!rlang::syms(heading_vars), !!!rlang::syms(stub_vars))

  data_cube <-
    source_data %>%
    dplyr::mutate(id = dplyr::row_number()) %>% # used to unpivot data later
    tidyr::pivot_longer(cols = all_of(stub_vars),
                        names_to = "variable",
                        values_to = "code"
                        ) %>%
    dplyr::left_join(codelist, by = c("variable", "code")) %>%
    tidyr::pivot_wider(names_from = variable,
                       values_from = c("code", "sortorder")
                       ) %>%
    dplyr::select(-id) %>%
    dplyr::arrange_at(heading_vars) %>%
    tidyr::pivot_wider(names_from = !!heading_vars, values_from = value) %>%
    dplyr::arrange_at(stringr::str_c("sortorder_", stub_vars)) %>%
    dplyr::select(-contains(stub_vars))

  return(data_cube)
}

#' Turn metadata and data cube into text lines that can be written to a px file.
#'
#' @param metadata Dataframe with metadata
#' @param data_cube Dataframe with data cube
format_px_data_as_lines <- function(metadata, data_cube) {
  metadata_lines <-
    stringr::str_c(metadata$keyword,
                   "=",
                   quote_unless_numeric_or_yes_no(metadata$value),
                   ";"
                   )

  data_lines <-
    data_cube %>%
    dplyr::mutate(dplyr::across(everything(), as.character),
                  dplyr::across(everything(), ~tidyr::replace_na(.x, '"-"'))
                  ) %>%
    tidyr::unite(tmp, sep = " ") %>%
    dplyr::pull(tmp)

  c(metadata_lines, "DATA=", data_lines, ";")
}

#' Save Excel 'Data' sheet as a temporary .rds data set that can be used by
#' other functions in the current R session.
#'
#' @param metadata_path Path to metadata file
create_temp_source_data <- function(metadata_path) {
  temp_source_data_path <- paste0(tempfile(), '.rds')

  metadata_path %>%
    readxl::read_excel(sheet = "Data") %>%
    saveRDS(file = temp_source_data_path)

  return(temp_source_data_path)
}

#' Create pxfile
#'
#' `pxmake()` creates a px file by combine source data from a `.rds` file and
#' metadata from an Excel workbook.
#'
#' @param metadata_path Path to Excel workbook with metadata.
#' @param pxfile_path Path to save px file at.
#' @param source_data_path Path to `.rds` file with data source, if left blank
#' `pxmake()` uses the data the metadata sheet 'Data'.
#' @return Nothing.
#'
#' @export
pxmake <- function(metadata_path, pxfile_path, source_data_path = NULL) {
  if (is.null(source_data_path)) {
    error_if_excel_sheet_does_not_exist("Data", metadata_path)

    source_data_path <- create_temp_source_data(metadata_path)
  }

  metadata  <- get_metadata(metadata_path, source_data_path)
  data_cube <- get_data_cube(metadata_path, source_data_path)

  px_lines <- format_px_data_as_lines(metadata, data_cube)

  file_connection <- file(pxfile_path)
  writeLines(px_lines, file_connection)
  close(file_connection)
}
