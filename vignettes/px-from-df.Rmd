---
title: "How to create a px-file from a data set"
output: rmarkdown::html_vignette
date: '`r Sys.time()`'
vignette: >
  %\VignetteIndexEntry{px-from-df}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

If you have a data frame that you want to convert to a px-file you need some meta data to describe the data. `pxmake` can help you create this, but creating a metadata template based on the data frame.

## Preparation 
1: Install experimental version of `pxmake`.

```{r, eval = FALSE}
# install.packages('devtools')
devtools::install_github('StatisticsGreenland/pxmake', 
                         ref = '167-metamake-from-dataset'
                         )
```

2: Run `packageVersion("pxmake")` and confirm that package version is `0.8.0.9001`.
```{r, eval = FALSE}
packageVersion("pxmake")
```

3: Load packages
```{r, message = FALSE}
library(tidyverse)
library(pxmake)
```

4: Create data set. It should have at least 3 variables, and the column with figures should be the last one.
```{r}
df <-
  world_bank_pop %>% 
  filter(indicator == "SP.POP.TOTL") %>% 
  filter(country %in% c("DNK", "SWE", "GRL")) %>% 
  select(-indicator) %>% 
  pivot_longer(cols = -country, names_to = "year")

df
```

## Create metadata

5: Run `metamake` on data set and specify `out_path` to create Excel workbook.

```{r}
metamake(df, out_path = 'population.xlsx')
```

6: (Optional) Modify the metadata in the Excel workbook.

## Create px file
7: Run `pxmake` on the  Excel workbook to create a px-file.
```{r}
pxmake('population.xlsx', out_path = 'population.px')
```

## Alternative option
If the intermediate Excel workbook isn't necessary, it's also possible to go directly from data frame to px-file by calling `pxmake` on `metamake`.
```{r}
df %>%
  metamake() %>% 
  pxmake(out_path = 'population2.px')
```

## Modifying metadata 
The initial version of the metadata is minimal. You will likely want to add and modify this, e.g. by adding a title, changing which variables are stub/heading, etc.. The easiest way to do it is to modify the metadata in the Excel workbook that `metamake()` can create.

Another possibility is to modify the metadata data set directly in R. See the example below.
```{r}
rds <- metamake(df)

# Initial metadata
rds$metadata


rds$metadata <-
  rds$metadata %>% 
  # Change title
  mutate(value = ifelse(keyword == "TITLE",
                        "My table title",
                        value
                        )
         ) %>% 
  # Add more keywords
  bind_rows(tribble(~keyword,        ~value,
                    "AXIS-VERSION",  list("2000"),
                    "CREATION-DATE", list(format(Sys.time(),format='%Y%m%d %H:%M'))
                    )
            )

pxmake(rds, out_path = 'population3.px')
```
